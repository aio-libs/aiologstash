language: python
sudo: false

python:
  - 3.5.3
  - &mainstream_python 3.6

env:
  global:
    - FLIT_USERNAME=aio-libs-bot
    - secure: "sRBzCSXpE5Ox9imspp1MzY8zYLu0B9KHf9jsYPfuKPh73KIh+/Otl8HL0RwYbmQ7s1X7W7tcNARu+UpXymxRbc0pbgn+4koYP90Hsu+bC2LGG3l20hmow11rk3sYQwK5kDncXdGXUxvCnGxqQvxiNf6kZ1E5oDnuyF7tVF+eklkShGgLIN8AK4Vyrlss9G6CPn17Vu7N7esvwnnjHiir1WNjqmIMvr1jVGaY5HwvZQWQiLOovos9xl8lQb/GAgXt8EzZkGDz9+SN8Zgbm/I+wjlDq4Ke037u4nS2cRrbbt5fJfWa6O1Jd2pFCSTb5fkTWrO5rT0WkF+Ml+z3kNdEIKg//XRUaFCs2QaNN4v8giKmizzqptX8s2N6nqkztRmudezF1AdKFF1l4u2qUkQaCXqELdgEp76FDnDUAK0+Jx+NOe0lapohV+1STNhbgQ1+J15Gre0IXLsh/KCxnl2TNh4mP/m5bPcSmvQTH1QtCju30n9hRSZh0NuwTiBYVolk8pjiipGJjYfZN6PmtnTUjfKRxptSV/qDp+24Dn+pWmPet9/kwm4VDjV8T/YiYSQ5R2CpDBMQVZr11IXhCxhtne001uC6/JrylbSv6ANzPTzhLxMsFQN3JJ7+TkQjl5kxxrbC4L+sL0URS/X59n9N100xXmFzP/zbJffgcjugchQ="


install:
  - travis_retry pip install -U setuptools pip wheel codecov
  - travis_retry pip install -r requirements/ci.txt
  - flit install --symlink
script:
  - make test
  - codecov
  - PYTHONASYNCIODEBUG=x make test
  - codecov

_helpers:
- &_mainstream_python_base
  python: *mainstream_python
- &_reset_steps
  env: []
  before_install: skip
  install: skip
  script: skip
  after_success: []

jobs:
  include:
  - stage: lint
    <<: *_mainstream_python_base
    <<: *_reset_steps
    install:
      - travis_retry pip install -r requirements/lint.txt
      - flit install --symlink
    script:
      - flake8 --show-source aiologstash
      - isort --check-only -rc aiologstash --diff
  - stage: deploy
    if: tag IS present
    <<: *_mainstream_python_base
    <<: *_reset_steps
    install:
      - travis_retry pip install -r requirements/ci.txt
    script:
      - flit publish

stages:
  - lint
  - test
  - name: deploy
    # This will prevent deploy unless it's a tagged commit:
    if: tag IS present

cache: pip
